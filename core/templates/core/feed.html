{% extends "base.html" %}
{% load static %}

{% block title %}Feed{% endblock %}

{% block content %}
<div class="feed-container">
    <h2 class="feed-title">Community Feed</h2>

    <div id="react-feed-root" style="margin-bottom: 1rem;"></div>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{% if message.tags == 'success' %}bg-green-100{% elif message.tags == 'error' %}bg-red-100{% else %}bg-blue-100{% endif %}">
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if user.is_authenticated %}
        <div class="create-post-card">
            <h3>Share Your Thoughts</h3>
            
            <form action="{% url 'feed' %}" method="POST">
                {% csrf_token %}
                
                {% for field in form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        
                        {% if field.errors %}
                            <p class="field-error">
                                {% for error in field.errors %}{{ error }}{% endfor %}
                            </p>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <button type="submit" class="btn primary">Post</button>
            </form>
        </div>
    {% else %}
        <div class="text-center" style="padding: 2rem;">
            <a href="{% url 'login' %}" class="btn primary">Log in to share</a>
        </div>
    {% endif %}

    <div class="posts-list">
        {% for post in posts %}
          <div class="post-card" data-post-id="{{ post.id }}">
            <div class="post-header">
              <div class="flex items-center gap-2">
                <div class="avatar-placeholder avatar-sm">{{ post.user.username|first|upper }}</div>
                <strong>{{ post.user.username }}</strong>
              </div>
              <div class="flex items-center gap-2">
                <span class="badge">{{ post.emotion_type|title }}</span>
                <small class="post-date">{{ post.created_at|date:"M j, g:i a" }}</small>
              </div>
            </div>

            <div class="post-body">
              <p>{{ post.content }}</p>
            </div>

            <div class="post-footer">
              {% if user.is_authenticated %}
                <form action="{% url 'like_post' post.id %}" method="POST" style="display:inline;" class="js-like-form">
                  {% csrf_token %}
                  <button type="submit" class="btn-action">
                    Agree <span id="like-count-{{ post.id }}">{{ post.like_count }}</span>
                  </button>
                </form>
                <form action="{% url 'dislike_post' post.id %}" method="POST" style="display:inline;" class="js-dislike-form">
                  {% csrf_token %}
                  <button type="submit" class="btn-action">
                    Disagree <span id="dislike-count-{{ post.id }}">{{ post.dislike_count }}</span>
                  </button>
                </form>
              {% endif %}
              <button class="toggle-comments-btn" data-post-id="{{ post.id }}" onclick="toggleComments('comments-{{ post.id }}', this)">
                Comments <span id="comment-count-{{ post.id }}">{{ post.comment_count }}</span>
              </button>
            </div>

            <div id="comments-{{ post.id }}" class="comments hidden">
                <div class="add-comment">
                    <form action="{% url 'comment_post' post.id %}" method="POST" class="js-comment-form" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        {{ comment_form.content }} 
                        <button type="submit" class="btn-comment">Send</button>
                    </form>
                </div>
                
                {% for comment in post.comment_set.all %} 
                  <div class="comment {% if comment.is_supportive %}highlight-support{% endif %}"> 
                    <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
                    <small>{{ comment.created_at|date:"M j, g:i a" }}</small>
                  </div>
                {% empty %}
                  <p class="text-muted text-sm">No comments yet</p>
                {% endfor %}
            </div>
          </div>
        {% empty %}
          <p class="empty-feed-text">No posts yet. Be the first!</p>
        {% endfor %}
    </div>
</div>
<script type="module" src="{% static 'frontend/assets/main.js' %}"></script>
<script defer src="{% static 'js/feed.js' %}"></script>
{% endblock %}